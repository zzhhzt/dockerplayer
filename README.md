# 扫码听歌 (Scan to Listen)

一个基于 Docker 的全栈音乐播放应用，包含公共播放器和受密码保护的管理后台。

## ✨ 功能特性

*   **🎵 公共播放器**: 简洁美观的 HTML5 播放器，自动扫描播放列表。
*   **📱 扫码听歌**: 管理后台生成二维码，扫码即可直接播放指定歌曲。
*   **🔐 管理后台**: 受密码保护的后台，支持文件管理和设置配置。
*   **🔒 高级防盗链**: 多层防护机制，防止音频文件被盗链。
*   **🌐 域名白名单**: 可配置允许访问的域名列表。
*   **🐳 Docker 部署**: 一键构建和运行，数据持久化存储。
*   **📱 响应式设计**: 完美适配移动端和桌面端。

## 📂 项目结构

```
.
├── admin/          # 管理后台前端代码
├── public/         # 公共播放器前端代码
├── music/          # 音乐文件存储目录 (自动创建)
├── server.js       # Node.js 后端服务
├── Dockerfile      # Docker 构建文件
├── docker-compose.yml # Docker 编排文件
├── .env            # 环境变量配置
└── package.json    # 项目依赖
```

## 🚀 快速开始 (Docker)

这是推荐的部署方式。

1.  **配置环境变量**
    创建一个 `.env` 文件（如果尚未创建）：
    ```bash
    # 管理员密码 (请设置为强密码)
    ADMIN_PASSWORD=your_secret_password

    # 允许的来源域名 (用逗号分隔，留空允许所有)
    # ALLOWED_ORIGINS=https://yoursite.com,https://www.yoursite.com

    # 媒体文件URL有效期 (毫秒)
    # MEDIA_URL_TTL=60000
    ```

2.  **启动服务**
    在项目根目录下运行：
    ```bash
    docker-compose up -d --build
    ```

3.  **访问应用**
    *   **播放器**: `http://localhost:8080` (或服务器 IP)
    *   **管理后台**: `http://localhost:8080/admin`
    *   **扫码听歌**: 在管理后台点击歌曲旁的“二维码”按钮。
        *   支持自定义**前景色**、**背景色**。
        *   支持上传 **Logo** 图片嵌入二维码中心。
        *   支持添加**自定义标题**。
        *   使用手机扫描生成的二维码即可直接播放。

## 🛠️ 本地开发 (Node.js)

如果你想在不使用 Docker 的情况下运行：

1.  安装依赖：
    ```bash
    npm install
    ```
2.  设置环境变量 (可选，默认为 'admin')：
    Windows (PowerShell):
    ```powershell
    $env:ADMIN_PASSWORD="your_password"; node server.js
    ```
    Linux/Mac:
    ```bash
    ADMIN_PASSWORD=your_password node server.js
    ```
3.  访问 `http://localhost:3000`。

## 🔌 API 文档

| 方法 | 路径 | 描述 | 权限 |
| :--- | :--- | :--- | :--- |
| `GET` | `/api/playlist` | 获取音乐列表 | 公开 |
| `POST` | `/api/upload` | 上传音乐文件 | 需要密码 |
| `DELETE` | `/api/music/:filename` | 删除音乐文件 | 需要密码 |

**鉴权方式**:
管理接口需要在 Header 中添加 `x-admin-password` 或在 URL 参数中添加 `?password=...`。

## 🔒 防盗链功能

本应用内置了强大的防盗链机制：

### 🛡️ 多层防护

1. **签名URL系统**: 音频文件通过临时签名URL访问，60秒后自动失效
2. **域名白名单**: 只允许配置的域名访问音频资源
3. **用户代理验证**: 阻止爬虫、下载工具等非浏览器访问
4. **请求频率限制**: 防止大规模盗用和恶意请求
5. **来源验证**: 严格验证HTTP Referer和Origin头部

### ⚙️ 配置方式

**自动内网访问** (无需配置):
系统会自动允许以下内网IP访问：
- `10.x.x.x` - 私有网络A类
- `172.16-31.x.x` - 私有网络B类
- `192.168.x.x` - 私有网络C类
- `127.x.x.x` - 本地回环
- `localhost` - 本地主机

**环境变量配置** (.env文件):
```bash
# 允许外网域名访问 (内网IP自动允许)
ALLOWED_ORIGINS=https://yoursite.com,https://partner-site.com
```

**后台配置**:
访问 `/admin` → 网站设置 → 允许的域名 (防盗链)

### 🎯 防护效果

- ✅ **阻止直接盗链**: 外部网站无法直接引用音频文件
- ✅ **防止爬虫抓取**: 自动阻止各种爬虫和下载工具
- ✅ **限制大流量**: 严格的请求频率限制
- ✅ **临时链接**: 音频URL自动过期失效
- ✅ **隐蔽路径**: URL格式经过混淆，难以猜测和逆向

## 📝 注意事项

*   音乐文件存储在本地的 `./music` 目录中。
*   默认端口映射为 `8080`，可在 `docker-compose.yml` 中修改。
*   建议在生产环境中使用HTTPS协议。
*   定期更改管理员密码以确保安全。
*   **内网访问**: `10.10.10.221` 等内网IP会自动被允许，无需额外配置。
*   **外网访问**: 需要在后台设置或环境变量中配置允许的域名。
